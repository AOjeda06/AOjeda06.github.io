<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SOCIEDAD SECRETA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>SOCIEDAD SECRETA</h1>
<h2>Andrés Ojeda Rodríguez</h2>
<br>
<ul id="instrucciones1">
	<h3>INSTRUCCIONES: </h3>
	<li>Introduce tu nomre, apellidos y llave</li>
	<li>Tu contraseña inicial será '1Q2W3E', despúes de cada login se le asignará una nueva para su siguiente login</li>
	<li>Todos los campos son obligatorios</li>
</ul>
<form>
        <label for="nombre">nombre:</label>
        <br> 
        <input type="nombre" id="nombre" name="nombre">
        <br>
        <label for="apellidos">apellidos:</label>
        <br> 
        <input type="apellidos" id="apellidos" name="apellidos">
        <br>
        <label for="password">password:</label>
        <br> 
        <input type="password" id="password" name="password">
        <br>
        <br>
        <button type="button" onclick="generarObj()">Enviar</button>
</form>
<br>
<br>
<p id="Error"></p>
<div id="instrucciones2"></div>
<div id="contenedor"></div>
</body>
<script type="text/javascript">
	let llave;

	function generarObj() {
		let objJson = {
			nombre: $("#nombre").val(),
            apellidos: $("#apellidos").val(),
            password: $("#password").val(),
            llave: "",
		}

		if (!objJson.nombre || !objJson.apellidos || !objJson.password /*|| !objJson.llave*/) {
                alert("Todos los campos son obligatorios.");
                return null;
            }

		console.log(objJson);
		enviarDatos(objJson);
	}

	function generarObj2(llave) {
		let objJson = {
			nombre: $("#nombre").val(),
            apellidos: $("#apellidos").val(),
            password: $("#password").val(),
            llave: llave,
		}

		if (!objJson.nombre || !objJson.apellidos || !objJson.password /*|| !objJson.llave*/) {
                alert("Todos los campos son obligatorios.");
                return null;
            }

		console.log(objJson);
		enviarDatos2(objJson);
	}

		function generarObj3(llave) {
		let objJson = {
			nombre: $("#nombre").val(),
            apellidos: $("#apellidos").val(),
            password: $("#password").val(),
            llave: llave,
		}

		if (!objJson.nombre || !objJson.apellidos || !objJson.password /*|| !objJson.llave*/) {
                alert("Todos los campos son obligatorios.");
                return null;
            }

		console.log(objJson);
		enviarDatos3(objJson);
	}

	function enviarDatos(objeto_js){
		$.ajax({
		        url: "https://lm.iesnervion.es/secret.php",
		        method: "POST",
		        data: JSON.stringify(objeto_js),
		        contentType: "application/json", // Especifica el tipo de contenido
		        dataType: "json", // La respuesta será interpretada como JSON
		        success: function(response) {
		            console.log(response);
		            imprimirInstrucciones(response.instrucciones);
		            generarObj2(response.llave);
		        },
		        error: function(xhr, status, error) {
		            imprimirError(`Error: ${xhr.status} - ${error}`);
		            console.log(`Error: ${xhr.status} - ${error}`);
		        }
		    });
	}

	function enviarDatos2(objeto_js){
		$.ajax({
		        url: "https://lm.iesnervion.es/secret.php",
		        method: "POST",
		        data: JSON.stringify(objeto_js),
		        contentType: "application/json", // Especifica el tipo de contenido
		        dataType: "json", // La respuesta será interpretada como JSON
		        success: function(response) {
		            console.log(response);
		            imprimirInstrucciones(response.instrucciones);
		            crearDiv();
		           	generarObj3(response.llave);
		        },
		        error: function(xhr, status, error) {
		            imprimirError(`Error: ${xhr.status} - ${error}`);
		            console.log(`Error: ${xhr.status} - ${error}`);
		        }
		    });
	}

	function enviarDatos3(objeto_js){
		$.ajax({
		        url: "https://lm.iesnervion.es/secret.php",
		        method: "POST",
		        data: JSON.stringify(objeto_js),
		        contentType: "application/json", // Especifica el tipo de contenido
		        dataType: "json", // La respuesta será interpretada como JSON
		        success: function(response) {
		            console.log(response);
		            imprimirInstrucciones(response.instrucciones);
		        },
		        error: function(xhr, status, error) {
		            imprimirError(`Error: ${xhr.status} - ${error}`);
		            console.log(`Error: ${xhr.status} - ${error}`);
		        }
		    });
	}

	function imprimirError(mensaje) {
            $("#Error").html("<h2>" + mensaje + "</h2>");
        }

    function imprimirInstrucciones(mensaje ) {
    	$("#instrucciones").empty();
    	mensaje.forEach(function(instruccion) {
            let instrucciones = "<ul>" + instruccion + "</ul>";
            $("#instrucciones2").append(instrucciones);
        });
    }

    function crearDiv() {
    	let div = 
    		"<div id= 'llave2'>"+"</div>";
    	
    	$("#contenedor").append(div);
    }

    function pulsa(btn) {
    	
    }
</script>
</html>